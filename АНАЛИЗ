function onEdit(e) {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ –Ω–∞ –ª–∏—Å—Ç–µ TEST –∏ –≤ –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã—Ö —è—á–µ–π–∫–∞—Ö D1:O1
  var range = e.range;
  var sheet = e.source.getActiveSheet();

  if (sheet.getName() === "–ê–ù–ê–õ–ò–ó" && range.getA1Notation() === "D1") {
    var newDate = range.getValue(); // –ü–æ–ª—É—á–∞–µ–º –Ω–æ–≤—É—é –¥–∞—Ç—É
    if (newDate) {
      var testSheet = e.source.getSheetByName("–ê–ù–ê–õ–ò–ó");
      testSheet.getRange("B3").setValue("–ê–ù–ê–õ–ò–ó –î–ê–ù–ù–´–•..."); // –£–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
      SpreadsheetApp.flush(); // –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
      markWithEmojiAndColorOptimized(newDate); // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑
      testSheet.getRange("B3").setValue("–ì–û–¢–û–í–û"); // –£–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –∞–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω
    }
  }
}

function markWithEmojiAndColorOptimized(analysisDate) {
  var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  var testSheet = spreadsheet.getSheetByName("–ê–ù–ê–õ–ò–ó");

  if (!analysisDate) {
    testSheet.getRange("B3").setValue("–û—à–∏–±–∫–∞: –£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –≤ D1.");
    return;
  }

  // **–ü–û–î–ì–û–¢–û–í–ö–ê**: –°—á–∏—Ç—ã–≤–∞–µ–º –≤—Å–µ –ª–∏—Å—Ç—ã PS –≤ –º–∞—Å—Å–∏–≤
  var repeatCounts = Array(16).fill(0); // –ü–æ–¥—Å—á—ë—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –ø–æ –∫–∞–∂–¥–æ–º—É PS-–ª–∏—Å—Ç—É
  var timesToMark = Array(16).fill(null).map(() => ({})); // –í—Ä–µ–º–µ–Ω–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ª–∏—Å—Ç–∞ PS

  for (var i = 1; i <= 16; i++) {
    var psSheet = spreadsheet.getSheetByName("PS" + i);
    if (!psSheet) continue;

    var psData = psSheet.getRange(3, 1, psSheet.getLastRow() - 2, 2).getValues(); // –î–∞—Ç—ã –∏ –≤—Ä–µ–º—è

    for (var j = 0; j < psData.length; j++) {
      var psDate = psData[j][0];
      var psTime = psData[j][1];

      if (psDate && psTime && psDate.getTime() === analysisDate.getTime()) {
        repeatCounts[i - 1]++;
        var formattedTime = typeof psTime === 'object'
          ? Utilities.formatDate(psTime, Session.getScriptTimeZone(), "HH:mm")
          : psTime.split(":").slice(0, 2).join(":");
        timesToMark[i - 1][formattedTime] = true; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ä–µ–∫—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
      }
    }
  }

  // **–û–ë–†–ê–ë–û–¢–ö–ê**: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ (00:00 - 23:59)
  var timeIntervals = [];
  for (var hour = 0; hour < 24; hour++) {
    for (var minute = 0; minute < 60; minute++) {
      var formattedTime = Utilities.formatString("%02d:%02d", hour, minute);
      timeIntervals.push(formattedTime);
    }
  }

  // **–ó–ê–ü–û–õ–ù–ï–ù–ò–ï**: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∑–∞–ø–∏—Å–∏
  var rowsData = Array(timeIntervals.length).fill(null).map(() => Array(16).fill(""));
  var colors = Array(timeIntervals.length).fill(null).map(() => Array(16).fill(null));

  for (var i = 0; i < timeIntervals.length; i++) {
    for (var psIndex = 0; psIndex < 16; psIndex++) {
      if (timesToMark[psIndex][timeIntervals[i]]) {
        rowsData[i][psIndex] = "üé≥";
        colors[i][psIndex] = "#dc143c"; // –ö—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç
      }
    }
  }

  // **–ó–ê–ü–ò–°–¨**: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏ —Ü–≤–µ—Ç–∞ –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
  testSheet.getRange(4, 3, rowsData.length, 16).setValues(rowsData); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º üé≥
  testSheet.getRange(4, 3, colors.length, 16).setBackgrounds(colors); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç–∞

  // **–ó–ê–ü–ò–°–¨ –ü–û–î–°–ß–Å–¢–ê**: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
  testSheet.getRange("C3:R3").setValues([repeatCounts]);

  // **–ò–ù–§–û–†–ú–ê–¶–ò–Ø**: –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –ª–æ–≥–∏
  Logger.log("–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π: " + repeatCounts.join(", "));
} 
